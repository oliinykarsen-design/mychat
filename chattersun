!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus Infinity Ultra - Final</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@1/index.js"></script>
    <style>
        :root {
            --primary: #00a884; --bg-dark: #0b141a; --panel: #202c33;
            --input-bg: #2a3942; --text: #e9edef; --my-msg: #005c4b;
            --danger: #f15c5c; --online: #00ff1a; --read: #53bdeb; --secondary: #8696a0;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        body { background: var(--bg-dark); color: var(--text); height: 100vh; display: flex; overflow: hidden; }

        /* --- AUTH --- */
        .auth-screen { position: fixed; inset: 0; background: #000; z-index: 10000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .auth-card { background: var(--panel); padding: 40px; border-radius: 24px; width: 380px; text-align: center; border: 1px solid #333; }
        .auth-input { width: 100%; padding: 12px; margin: 8px 0; border-radius: 10px; border: 1px solid #444; background: var(--input-bg); color: #fff; outline: none; }
        .auth-btn { width: 100%; padding: 14px; border-radius: 10px; border: none; background: var(--primary); color: white; font-weight: bold; cursor: pointer; margin-top: 10px; }

        /* --- SIDEBAR --- */
        .sidebar { width: 380px; background: #111b21; border-right: 1px solid #2c3943; display: flex; flex-direction: column; }
        .sb-header { padding: 10px 16px; background: var(--panel); display: flex; align-items: center; justify-content: space-between; height: 60px; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; background: #333; cursor: pointer; }
        .list-container { flex: 1; overflow-y: auto; }
        .user-row { padding: 12px 16px; border-bottom: 1px solid #222; cursor: pointer; display: flex; align-items: center; gap: 15px; position: relative; transition: 0.2s; }
        .user-row:hover { background: var(--input-bg); }
        .online-dot { width: 10px; height: 10px; background: var(--online); border-radius: 50%; border: 2px solid #111b21; position: absolute; bottom: 14px; left: 42px; }

        /* --- CHAT AREA --- */
        .chat-window { flex: 1; display: flex; flex-direction: column; background: #0b141a; position: relative; }
        .msgs-container { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 4px; background: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-blend-mode: overlay; background-color: #0b141a; }
        .bubble-wrap { display: flex; width: 100%; }
        .bubble-wrap.me { justify-content: flex-end; }
        .bubble { max-width: 65%; padding: 8px 12px; border-radius: 8px; position: relative; box-shadow: 0 1px 1px rgba(0,0,0,0.2); word-wrap: break-word; }
        .me .bubble { background: var(--my-msg); border-top-right-radius: 0; }
        .them .bubble { background: var(--panel); border-top-left-radius: 0; }
        .img-msg { max-width: 100%; border-radius: 8px; margin-top: 5px; cursor: pointer; }

        /* --- FOOTER & INPUT --- */
        .footer { padding: 10px 16px; background: var(--panel); display: flex; align-items: center; gap: 12px; }
        .input-box { flex: 1; background: var(--input-bg); padding: 10px 15px; border-radius: 20px; border: none; color: #fff; outline: none; font-size: 1rem; }
        .recording-active { color: var(--danger) !important; animation: pulse 1s infinite; }
        @keyframes pulse { 50% { opacity: 0.4; } }

        /* --- VIDEO CALL UI --- */
        #call-screen { position: fixed; inset: 0; background: #000; z-index: 20000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .video-container { position: relative; width: 90%; max-width: 1200px; display: flex; gap: 10px; }
        video { width: 50%; border-radius: 15px; background: #222; transform: scaleX(-1); border: 2px solid #333; }
        .call-tools { position: absolute; bottom: -80px; left: 50%; transform: translateX(-50%); display: flex; gap: 20px; }
        .call-btn { width: 60px; height: 60px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: #fff; }

        #emoji-pop { position: absolute; bottom: 70px; left: 10px; display: none; z-index: 1000; }
    </style>
</head>
<body>

<audio id="snd-msg" src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3"></audio>

<div id="auth-box" class="auth-screen">
    <div class="auth-card">
        <h2 style="color:var(--primary); margin-bottom:20px">NEXUS INFINITY ULTRA</h2>
        <div id="reg-inputs">
            <input type="text" id="a-tag" class="auth-input" placeholder="@нікнейм">
            <input type="text" id="a-user" class="auth-input" placeholder="Ім'я">
        </div>
        <input type="email" id="a-mail" class="auth-input" placeholder="Email">
        <input type="password" id="a-pass" class="auth-input" placeholder="Пароль">
        <button class="auth-btn" onclick="runAuth('login')">УВІЙТИ</button>
        <button class="auth-btn" style="background:none; border:1px solid var(--primary)" onclick="runAuth('reg')">РЕЄСТРАЦІЯ</button>
    </div>
</div>

<div id="call-screen">
    <h2 id="call-info" style="margin-bottom:20px; color:var(--primary)">Відеодзвінок...</h2>
    <div class="video-container">
        <video id="local-v" autoplay muted playsinline></video>
        <video id="remote-v" autoplay playsinline></video>
        <div class="call-tools">
            <button id="btn-answer" class="call-btn" style="background:#4cd964; display:none" onclick="acceptCall()"><i class="fas fa-phone"></i></button>
            <button class="call-btn" style="background:#ff3b30" onclick="hangUp()"><i class="fas fa-phone-slash"></i></button>
        </div>
    </div>
</div>

<div class="sidebar">
    <div class="sb-header">
        <img id="my-avatar" class="avatar" src="">
        <b id="my-name">...</b>
        <i class="fas fa-sign-out-alt" style="cursor:pointer; color:var(--secondary)" onclick="logout()"></i>
    </div>
    <div id="contacts" class="list-container"></div>
</div>

<div class="chat-window">
    <header class="sb-header">
        <div style="display:flex; align-items:center; gap:12px">
            <img id="c-avatar" class="avatar" src="https://ui-avatars.com/api/?name=?">
            <div>
                <b id="c-title">Оберіть чат</b>
                <div id="c-status" style="font-size:0.7rem; color:var(--primary)"></div>
            </div>
        </div>
        <i id="v-call-trigger" class="fas fa-video" style="cursor:pointer; color:var(--primary); font-size:1.3rem; display:none" onclick="initiateCall()"></i>
    </header>

    <div id="chat-msgs" class="msgs-container"></div>

    <div id="emoji-pop"><emoji-picker class="dark"></emoji-picker></div>

    <footer class="footer">
        <i class="far fa-smile" style="cursor:pointer; font-size:1.5rem; color:var(--secondary)" onclick="toggleEmoji()"></i>
        <label for="file-in" style="cursor:pointer"><i class="fas fa-plus" style="font-size:1.3rem; color:var(--secondary)"></i></label>
        <input type="file" id="file-in" style="display:none" accept="image/*" onchange="sendImage(this)">
        <input type="text" id="msg-input" class="input-box" placeholder="Повідомлення..." autocomplete="off">
        <i id="voice-trigger" class="fas fa-microphone" style="cursor:pointer; font-size:1.4rem; color:var(--secondary)"></i>
        <i id="send-trigger" class="fas fa-paper-plane" style="display:none; color:var(--primary); cursor:pointer; font-size:1.4rem" onclick="submitMsg()"></i>
    </footer>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, set, onChildAdded, onValue, update, off, onDisconnect, serverTimestamp, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const config = {
        apiKey: "AIzaSyClFOMxAzvXcWFM9wlz6ZmtfvgOW14Vs5w",
        authDomain: "chattersun-174b5.firebaseapp.com",
        databaseURL: "https://chattersun-174b5-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "chattersun-174b5",
        storageBucket: "chattersun-174b5.firebasestorage.app",
        messagingSenderId: "786057798847",
        appId: "1:786057798847:web:32a34d9abc22087289d20a"
    };

    const app = initializeApp(config);
    const db = getDatabase(app);
    const auth = getAuth(app);

    let me = null, activeChat = null, peerConn = null, stream = null, chatRef = null, mediaRec = null, audioChunks = [];

    // --- AUTH ---
    window.runAuth = async (mode) => {
        const email = document.getElementById('a-mail').value;
        const pass = document.getElementById('a-pass').value;
        try {
            const res = mode === 'reg' ? await createUserWithEmailAndPassword(auth, email, pass) : await signInWithEmailAndPassword(auth, email, pass);
            if(mode === 'reg') {
                await set(ref(db, `v30/users/${res.user.uid}`), {
                    uid: res.user.uid, name: document.getElementById('a-user').value, tag: document.getElementById('a-tag').value, online: true
                });
            }
            location.reload();
        } catch(e) { alert(e.message); }
    };

    onAuthStateChanged(auth, user => {
        if(user) {
            me = user;
            document.getElementById('auth-box').style.display = 'none';
            const myRef = ref(db, `v30/users/${user.uid}`);
            update(myRef, { online: true });
            onDisconnect(myRef).update({ online: false, lastSeen: serverTimestamp() });
            onValue(myRef, s => {
                const d = s.val();
                document.getElementById('my-name').innerText = d.name;
                document.getElementById('my-avatar').src = `https://ui-avatars.com/api/?name=${d.name}&background=00a884&color=fff`;
            });
            loadContacts();
            listenInboundCalls();
        }
    });

    window.logout = () => signOut(auth).then(() => location.reload());

    // --- MESSAGING ---
    const input = document.getElementById('msg-input');
    input.oninput = () => {
        const hasVal = input.value.trim().length > 0;
        document.getElementById('send-trigger').style.display = hasVal ? 'block' : 'none';
        document.getElementById('voice-trigger').style.display = hasVal ? 'none' : 'block';
    };

    window.submitMsg = (payload = {}) => {
        const text = input.value.trim();
        if(!text && !payload.voice && !payload.img) return;
        const room = me.uid < activeChat ? `${me.uid}_${activeChat}` : `${activeChat}_${me.uid}`;
        push(ref(db, `v30/msgs/${room}`), {
            sid: me.uid,
            txt: text || null,
            voice: payload.voice || null,
            img: payload.img || null,
            read: false,
            time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})
        });
        input.value = "";
        input.dispatchEvent(new Event('input'));
        document.getElementById('emoji-pop').style.display = 'none';
    };

    // --- FILES (IMAGE +) ---
    window.sendImage = (el) => {
        const file = el.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => submitMsg({ img: e.target.result });
        reader.readAsDataURL(file);
    };

    // --- VOICE ---
    const voiceBtn = document.getElementById('voice-trigger');
    voiceBtn.onmousedown = async () => {
        const s = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRec = new MediaRecorder(s);
        audioChunks = [];
        mediaRec.ondataavailable = e => audioChunks.push(e.data);
        mediaRec.onstop = () => {
            const blob = new Blob(audioChunks, { type: 'audio/webm' });
            const r = new FileReader();
            r.readAsDataURL(blob);
            r.onloadend = () => submitMsg({ voice: r.result });
            s.getTracks().forEach(t => t.stop());
        };
        mediaRec.start();
        voiceBtn.classList.add('recording-active');
    };
    voiceBtn.onmouseup = () => {
        if(mediaRec) {
            mediaRec.stop();
            voiceBtn.classList.remove('recording-active');
        }
    };

    // --- CHAT LOGIC ---
    window.openChat = (uid, name, avatar) => {
        if(chatRef) off(chatRef);
        activeChat = uid;
        document.getElementById('c-title').innerText = name;
        document.getElementById('c-avatar').src = avatar;
        document.getElementById('v-call-trigger').style.display = 'block';
        
        const room = me.uid < uid ? `${me.uid}_${uid}` : `${uid}_${me.uid}`;
        const container = document.getElementById('chat-msgs');
        container.innerHTML = "";
        
        chatRef = ref(db, `v30/msgs/${room}`);
        onChildAdded(chatRef, s => {
            const d = s.val();
            const isMe = d.sid === me.uid;
            if(!isMe && !d.read) update(ref(db, `v30/msgs/${room}/${s.key}`), { read: true });

            const div = document.createElement('div');
            div.className = `bubble-wrap ${isMe ? 'me' : 'them'}`;
            div.innerHTML = `
                <div class="bubble">
                    ${d.img ? `<img src="${d.img}" class="img-msg" onclick="window.open('${d.img}')">` : ''}
                    ${d.txt ? `<div>${d.txt}</div>` : ''}
                    ${d.voice ? `<audio controls src="${d.voice}" style="height:30px; width:200px; margin-top:5px"></audio>` : ''}
                    <div style="font-size:0.6rem; text-align:right; opacity:0.6; margin-top:4px">
                        ${d.time} ${isMe ? `<i class="fas fa-check-double" style="color:${d.read ? '#53bdeb' : '#8696a0'}"></i>` : ''}
                    </div>
                </div>`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            if(!isMe) document.getElementById('snd-msg').play().catch(()=>{});
        });
    };

    // --- VIDEO CALLS (STABLE) ---
    const iceServers = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

    window.initiateCall = async () => {
        document.getElementById('call-screen').style.display = 'flex';
        stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        document.getElementById('local-v').srcObject = stream;

        peerConn = new RTCPeerConnection(iceServers);
        stream.getTracks().forEach(t => peerConn.addTrack(t, stream));

        peerConn.onicecandidate = e => {
            if(e.candidate) push(ref(db, `v30/calls/${activeChat}/ice`), e.candidate.toJSON());
        };
        peerConn.ontrack = e => document.getElementById('remote-v').srcObject = e.streams[0];

        const offer = await peerConn.createOffer();
        await peerConn.setLocalDescription(offer);
        
        await set(ref(db, `v30/calls/${activeChat}/signal`), {
            offer, from: me.uid, name: document.getElementById('my-name').innerText
        });

        onValue(ref(db, `v30/calls/${activeChat}/answer`), s => {
            if(s.val()) peerConn.setRemoteDescription(new RTCSessionDescription(s.val()));
        });
    };

    function listenInboundCalls() {
        onValue(ref(db, `v30/calls/${me.uid}/signal`), async s => {
            const data = s.val();
            if(data) {
                document.getElementById('call-screen').style.display = 'flex';
                document.getElementById('btn-answer').style.display = 'block';
                document.getElementById('call-info').innerText = `Дзвінок від ${data.name}`;
                activeChat = data.from;
            }
        });
    }

    window.acceptCall = async () => {
        document.getElementById('btn-answer').style.display = 'none';
        stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        document.getElementById('local-v').srcObject = stream;

        peerConn = new RTCPeerConnection(iceServers);
        stream.getTracks().forEach(t => peerConn.addTrack(t, stream));
        peerConn.ontrack = e => document.getElementById('remote-v').srcObject = e.streams[0];
        peerConn.onicecandidate = e => {
            if(e.candidate) push(ref(db, `v30/calls/${activeChat}/ice`), e.candidate.toJSON());
        };

        const signalSnap = await onValue(ref(db, `v30/calls/${me.uid}/signal`), async s => {
            const d = s.val();
            await peerConn.setRemoteDescription(new RTCSessionDescription(d.offer));
            const ans = await peerConn.createAnswer();
            await peerConn.setLocalDescription(ans);
            await set(ref(db, `v30/calls/${d.from}/answer`), ans);
        }, { onlyOnce: true });

        onChildAdded(ref(db, `v30/calls/${me.uid}/ice`), s => {
            peerConn.addIceCandidate(new RTCIceCandidate(s.val())).catch(e => {});
        });
    };

    window.hangUp = () => {
        if(peerConn) peerConn.close();
        if(stream) stream.getTracks().forEach(t => t.stop());
        remove(ref(db, `v30/calls/${me.uid}`));
        location.reload();
    };

    // --- UI HELPERS ---
    window.toggleEmoji = () => {
        const p = document.getElementById('emoji-pop');
        p.style.display = p.style.display === 'block' ? 'none' : 'block';
    };
    document.querySelector('emoji-picker').addEventListener('emoji-click', e => {
        input.value += e.detail.unicode;
        input.dispatchEvent(new Event('input'));
    });

    function loadContacts() {
        onValue(ref(db, 'v30/users'), snap => {
            const list = document.getElementById('contacts');
            list.innerHTML = "";
            snap.forEach(c => {
                const u = c.val();
                if(u.uid === me.uid) return;
                const avatar = `https://ui-avatars.com/api/?name=${u.name}&background=random`;
                const div = document.createElement('div');
                div.className = 'user-row';
                div.innerHTML = `
                    <img src="${avatar}" class="avatar">
                    ${u.online ? '<div class="online-dot"></div>' : ''}
                    <div><b>${u.name}</b><br><small style="color:var(--secondary)">${u.online ? 'у мережі' : 'немає на місці'}</small></div>`;
                div.onclick = () => openChat(u.uid, u.name, avatar);
                list.appendChild(div);
            });
        });
    }
</script>
</body>
</html>
